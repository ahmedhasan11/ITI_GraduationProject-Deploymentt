<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClickClinic</title>

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="~/css/styles.css" />

    @RenderSection("Styles", required: false)
</head>
<body class="d-flex flex-column min-vh-100">

    <!-- Header -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <!-- Brand -->
            <a class="navbar-brand" asp-controller="Home" asp-action="Index">ClickClinic</a>

            <!-- Mobile Toggler aligned right -->
            <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Center Menu -->
            <div class="collapse navbar-collapse center-menu" id="navbarContent">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action("Index", "Home")#features">Features</a></li>
                    <li class="nav-item"><a class="nav-link" asp-controller="Home" asp-action="GetMedicines">Medicines</a></li>
                    <li class="nav-item"><a class="nav-link" asp-controller="Home" asp-action="GetDoctors">Doctors</a></li>
                </ul>

                <!-- Mobile actions (replaces right icons on small screens) -->
                <div class="d-lg-none mt-2 pt-2" style="border-top: 1px solid var(--light-border);">
                    <div class="menu-section-title">Quick actions</div>
                    <a class="nav-link px-0" asp-controller="ChatPage" asp-action="Index">
                        <i class="fa-solid fa-comments me-2 text-primary"></i>Chat
                    </a>
                    <a class="nav-link px-0" asp-controller="Cart" asp-action="Index">
                        <i class="fa-solid fa-shopping-cart me-2 text-primary"></i>Cart
                    </a>
                    <a class="nav-link px-0" href="/profile">
                        <i class="fa-solid fa-user me-2 text-primary"></i>Profile
                    </a>
                </div>
            </div>

            <!-- Right Menu - Fixed Dropdowns -->
            <div class="right-menu">
                <ul class="navbar-nav flex-row">
                    <!-- Chat -->
                    <li class="nav-item">
                        <a class="nav-link nav-icon" asp-controller="ChatPage" asp-action="Index">
                            <i class="fa-solid fa-comments"></i>
                        </a>
                    </li>

                    <!-- Cart Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link nav-icon" href="#" id="cartDropdown"
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-solid fa-shopping-cart"></i>
                            <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge badge-custom">0</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end cart-dropdown" aria-labelledby="cartDropdown" id="cart-dropdown-menu">
                            <div id="cart-dropdown-items">
                                <p class="text-muted px-3">Loading...</p>
                            </div>
                        </div>
                    </li>

                    <!-- Profile Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link nav-icon" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-solid fa-user"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                            @if (!User.Identity.IsAuthenticated)
                            {
                                <a class="dropdown-item" href="/Account/Login">
                                    <i class="fa-solid fa-sign-in-alt"></i> Login
                                </a>
                                <a class="dropdown-item" href="/Account/Register">
                                    <i class="fa-solid fa-user-plus"></i> Register
                                </a>
                            }
                            else
                            {
                                <div class="px-3 py-2 text-center mb-2">
                                    <div class="profile-icon mx-auto mb-2" style="width:50px;height:50px;border-radius:50%;overflow:hidden;background:#f0f0f0;">
                                        <img src="@Url.Content("~/images/profiles/default.png")" alt="Profile" class="img-fluid" />
                                        <!-- Replace with actual user image if available -->
                                    </div>
                                    <h6 class="mb-0">@User.Identity.Name</h6>
                                    <small class="d-block text-muted">@User.FindFirst("Email")?.Value</small> <!-- Email second -->
                                    <small class="d-block text-secondary">
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <span>Admin</span>
                                        }
                                        else if (User.IsInRole("Doctor"))
                                        {
                                            <span>Doctor</span>
                                        }
                                        else if (User.IsInRole("Patient"))
                                        {
                                            <span>Patient</span>
                                        }
                                    </small>
                                </div>
                                <hr class="dropdown-divider">

                                @if (User.IsInRole("Admin"))
                                {
                                    <a class="dropdown-item" href="/Admin/PendingDoctors">
                                        <i class="fa-solid fa-tachometer-alt text-primary"></i> Dashboard
                                    </a>
                                }
                                else if (User.IsInRole("Patient"))
                                {
                                    <a class="dropdown-item" href="/Appointment/PatientAppointments">
                                        <i class="fa-solid fa-calendar-check text-primary"></i> Appointments
                                    </a>
                                    <a class="dropdown-item" href="/Order/GetOrderHistory">
                                        <i class="fa-solid fa-box text-secondary"></i> Orders
                                    </a>
                                }
                                else if (User.IsInRole("Doctor"))
                                {
                                    <a class="dropdown-item" href="/Appointment/Myappointments">
                                        <i class="fa-solid fa-calendar-check text-primary"></i> MyAppointments
                                    </a>
                                }

                                <hr class="dropdown-divider">

                                <!-- Logout Form -->
                                <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="fa-solid fa-sign-out-alt"></i> Logout
                                    </button>
                                </form>
                            }
                        </div>
                    </li>

                </ul>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main>
        @RenderBody()
    </main>

    <!-- Enhanced Footer -->
    <footer class="mt-auto position-relative">
        <div class="footer-floating"></div>
        <div class="footer-floating"></div>
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">ClickClinic</div>
                    <p class="footer-description">
                        Your trusted medical companion for medicines, doctor consultations,
                        and AI-powered medical assistance.
                    </p>
                </div>

                <div class="footer-column">
                    <h4>Quick Links</h4>
                    <ul class="footer-links">
                        <li><a asp-controller="Home" asp-action="Index"> <i class="fas fa-chevron-right"></i> Home</a></li>
                        <li><a href="@Url.Action("Index", "Home")#features"> <i class="fas fa-chevron-right"></i> Features</a></li>
                        <li><a asp-controller="Home" asp-action="GetMedicines"> <i class="fas fa-chevron-right"></i> Medicines</a></li>
                        <li><a asp-controller="Home" asp-action="GetDoctors"> <i class="fas fa-chevron-right"></i> Doctors</a></li>
                        <li><a asp-controller="Home" asp-action="About"> <i class="fas fa-chevron-right"></i> About Us</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h4>Contact Info</h4>
                    <div class="footer-contact">
                        <p><i class="fas fa-envelope"></i> AhmedBasem0104@gmail.com</p>
                        <p><i class="fas fa-phone"></i> +20 123 456 7890</p>
                        <p><i class="fas fa-map-marker-alt"></i> Mansoura, Egypt</p>
                    </div>
                    <div class="footer-social">
                        <a href="https://www.facebook.com/ahmed.basem.2004" target="_blank"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://x.com/AhmedBasem04" target="_blank"><i class="fab fa-twitter"></i></a>
                        <a href="https://github.com/Basem0" target="_blank"><i class="fa-brands fa-github"></i></a>
                        <a href="https://www.linkedin.com/in/ahmed-basem0104/" target="_blank"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 ClickClinic. All Rights Reserved. | Your Health, Our Priority</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Bootstrap dropdowns
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all dropdowns
            var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'))
            var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl)
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function (event) {
                var isDropdown = event.target.matches('.dropdown-toggle') ||
                                 event.target.closest('.dropdown-toggle') ||
                                 event.target.matches('.dropdown-menu') ||
                                 event.target.closest('.dropdown-menu');

                if (!isDropdown) {
                    dropdownList.forEach(function(dropdown) {
                        dropdown.hide();
                    });
                }
            });
        });

        async function refreshCart() {
            try {
                const countRes = await fetch('/Cart/GetCartCount');
                const countData = await countRes.json();
                document.getElementById('cart-count').innerText = countData.count;

                const dropdownRes = await fetch('/Cart/GetCartItemsDropdown');
                const dropdownHtml = await dropdownRes.text();
                document.getElementById('cart-dropdown-items').innerHTML = dropdownHtml;
            } catch (error) {
                console.error('Error refreshing cart:', error);
            }
        }

        async function addToCart(medicineId, quantity = 1) {
            try {
                const res = await fetch('/Cart/Add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MedicineId: medicineId, Quantity: quantity })
                });

                const data = await res.json();
                if (data.success) {
                    await refreshCart();
                } else {
                    alert("Failed to add to cart");
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                alert("An error occurred while adding to cart");
            }
        }

        // Attach events
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const medicineId = btn.dataset.medicineId;
                    addToCart(medicineId);
                });
            });

            refreshCart();
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>